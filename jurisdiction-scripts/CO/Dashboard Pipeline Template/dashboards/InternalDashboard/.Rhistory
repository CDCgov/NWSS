library(shiny); runApp('K:/Wastewater Surveillance/R codes/InternalDashboard/WWInternalDashboardV2/app_measles.R')
#Clear environment by removing all variables and functions
remove(list=ls())
#set this to your computer name
user_folder <- "rashaw"
#assign working directories
setwd(paste0("C:/Users/", user_folder, "/Documents/GitHub/Internal-Dashboard-Repo"))
getwd()
#assign path to local output folder
localpath_output <- paste0("C:/Users/", user_folder, "/Documents/R codes")
#Load libraries and additional functions
source("r scripts/libraries and functions.r")
#authorize google drive account
DLH_Email = "rshaw@cdphecore.cloud"
drive_auth(email = DLH_Email, cache = TRUE)
bq_auth(email = DLH_Email)
gs4_auth(cache = ".secrets", email = DLH_Email)
##read in reference sheets from google and save updated copies to K drive
source("r scripts/Read Reference Sheets.R")
#Compiler that pulls add data together from CSU, CDPHE, and DU folders on K drive
source("r scripts/WW Data Compiler_V2.r")
print(new_row_datacompliler)
#flu a subtyping
source("r scripts/Hx Detection Status.r")
print(new_row_hxdetection)
#Get relevant CDPHE case data from server
source("r scripts/Import_Case_Data.R")
print(new_row_importcases)
#Add columns with Omicron Variant Data
#This pulls the summary output from Omicron Detection Heatmap code and outputs as SARS-CoV-2_Omicron_Results_[date].csv
source("r scripts/Omicron_Sequencing_Addon.R")
print(new_row_omicron)
#Mash all the data together and send it to the K drive
#This exports data locally, to the K drive, and to the app
source("r scripts/Prepare_Case_Data_Compiler.r")
print(new_row_preparecompiler)
#######################################
###           TRENDS                ###
#######################################
#sars trends
source("r scripts/bsts_IDtrends.R")
source("r scripts/trend_percentiles_plot.R")
source("r scripts/CDC_detection_status.R")
#prep files for Public Dashboard
source("r scripts/Prep_PFD_Files.R")
#This updates permissions for the app by interfacing with REDCap
source(paste0(localpath_output,'/InternalDashboard/Permissions.R'))
#######################################
###         QC Reports              ###
#######################################
#combine ww data with trends, create output for IDB
source("r scripts/NWSS Flags.R")
#run markdown validation report before deploying (results saved in QC Reports folder)
rmarkdown::render("K:/Wastewater Surveillance/R codes/output/QC Reports/WastewaterValidationReport.Rmd")
###########################################
#Deploy app
source(paste0(localpath_output, '/InternalDashboard/Deploy App.R'))
# print("### Deploying EVD-68 App ###")
#Deploy app
source(paste0(localpath_output, '/InternalDashboard/Deploy App_EVD68.R'))
# print("### Deploying EVD-68 App ###")
#Deploy app
source(paste0(localpath_output, '/InternalDashboard/Deploy App_EVD68.R'))
runApp('K:/Wastewater Surveillance/R codes/InternalDashboard/WWInternalDashboardV2/app_measles.R')
#Clear environment by removing all variables and functions
remove(list=ls())
#set this to your computer name
user_folder <- "rashaw" #can easily change here for other team members
#assign working directories
setwd(paste0("C:/Users/", user_folder, "/Documents/GitHub/WW-Data-Analytics-Repo/NWSS Dashboard Template"))
getwd()
#assign path to local output folder
localpath_output <- paste0("C:/Users/", user_folder, "/Documents/GitHub/WW-Data-Analytics-Repo/NWSS Dashboard Template/r_scripts")
#Load libraries and additional functions
source("r_scripts/libraries and functions.r")
#authorize google drive account for LIMS and DLH
DLH_Email = "rshaw@cdphecore.cloud"
drive_auth(email = DLH_Email, cache = TRUE)
bq_auth(email = DLH_Email)
gs4_auth(cache = ".secrets", email = DLH_Email)
##read in reference sheets from google and save updated copies to K drive
source("r_scripts/Read Reference Sheets.R")
#Compiler that pulls add data together from CSU, CDPHE, and DU folders on K drive
source("r_scripts/WW Data Compiler.R")
#flu a subtyping
source("r_scripts/Hx Detection Status.r")
#Get relevant CDPHE case data from server
source("r_scripts/Import_Case_Data.R")
#Import and write compiled sars sequencing data
source("r_scripts/sequencing_sars-cov-2.R")
#Mash all the data together and send it to the K drive
source("r_scripts/Prepare_Case_Data_Compiler.r")
#######################################
###           TRENDS                ###
#######################################
source("r_scripts/bsts_IDtrends.R")
source("r_scripts/trend_percentiles_plot.R")
source("r_scripts/CDC_detection_status.R")
#combine ww data with trends, create output for IDB
source("r_scripts/Combine_DataTrends_IDBOutput.r")
#prep files for PFD
source("r_scripts/Prep_PFD_Files.R")
#run markdown validation report before deploying
rmarkdown::render("output/validation_reports/WastewaterValidationReport.Rmd")
#Deploy app
## You will need to adjust Deploy App script with your rshiny info before deploying
# source('r_scripts/Deploy App_Template.R'))
source('C:/Users/rashaw/Documents/R codes/InternalDashboard/Deploy App_NWSSTemplate_RS.R')
#Deploy app
## You will need to adjust Deploy App script with your rshiny info before deploying
# source('r_scripts/Deploy App_Template.R'))
source('C:/Users/rashaw/Documents/R codes/InternalDashboard/Deploy App_NWSSTemplate_RS.R')
##import trend percentile plot data
plot_dat <- read.csv("data/trend_percentile_data.csv") %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d")) %>%
mutate(sig = case_when(sig == "Not Significant" ~ "Trend Slope Not Significant", TRUE ~ "Trend Slope Significant"))
setwd("C:/Users/rashaw/Documents/GitHub/WW-Data-Analytics-Repo/NWSS Dashboard Template")
setwd("C:/Users/rashaw/Documents/GitHub/WW-Data-Analytics-Repo/NWSS Dashboard Template/dashboards/InternalDashboard")
{
# Load packages
library(pacman)
p_load(
tidyverse,
stringr,
readxl,
readr,
ggthemes,
plotly,
lubridate,
sf,
skimr,
leaflet,
shiny,
shinyjs,
ggplot2,
shinydashboard,
dplyr,
conflicted,
htmltools,
magrittr,
scales,
dygraphs,
kableExtra
)
library(shinyauthr)
library(viridis)
conflict_prefer("box", "shinydashboard")
conflict_prefer("filter", "dplyr")
conflict_prefer("layout", "plotly")
#Define Favorite Utility Function
"%!in%" <- function(x, y)
! ('%in%'(x, y))
####################################
##          READ IN DATA          ##
####################################
#Read in credentials
user_base <- readRDS("user_base.rds")
# System data
System_Data <-
read.csv(
normalizePath(
"data/System Data.csv"
)
)  %>%
mutate(utility = wwtp_name) %>%
select(-wwtp_name)
#metadata classifications
metadata_survey <- System_Data %>%
select(utility, surveyed_classification)
#data dictionary
data_dictionary <- read.csv("data/IDB Data Dictionary.csv")
IDB_masterlist <- read.csv("data/IDB_masterlist.csv") %>%
mutate(utility = wwtp_name)
SSS_masterlist <- IDB_masterlist %>%
filter(Surv_System == "SSS")
#viral concentration / metadata
#import metadata (need AddtoCompiler script to output this file)
wwdatafull <- read.csv("data/wwdatafull.csv") %>%
mutate(measure_date = lubridate::as_date(measure_date, format = "%Y-%m-%d")) %>%
group_by(utility, pcr_target)
#import flua subtyping
flua_subtyping_data <- read.csv("data/flua_hx_data.csv") %>%
rename(utility = wwtp_name) %>%
rename(measure_date = sample_collect_date) %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d")) %>%
mutate(flu_pcr_target = case_when(flu_pcr_target == "Inf_A-MP" ~ "FLUAV",
TRUE ~ flu_pcr_target))
##import trend percentile plot data
plot_dat <- read.csv("data/trend_percentile_data.csv") %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d")) %>%
mutate(sig = case_when(sig == "Not Significant" ~ "Trend Slope Not Significant", TRUE ~ "Trend Slope Significant"))
#import county level case data
countycase_data <- read.csv("data/CountyCases_Sars-CoV-2.csv") %>%
mutate(measure_date = as.Date(Date, format = "%Y-%m-%d")) %>%
select(-Date) %>%
mutate_all(~ ifelse(is.na(.), -1, .)) %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d"))
countycase_data_flursv <- read.csv("data/CountyCases_FluRSV.csv") %>%
mutate(measure_date = as.Date(Date, format = "%Y-%m-%d")) %>%
select(-Date) %>%
mutate_all(~ ifelse(is.na(.), -1, .)) %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d"))
countycase_data_flursv_hosp <- read.csv("data/CountyCases_FluRSV_Hospitalization.csv") %>%
mutate(measure_date = as.Date(Date, format = "%Y-%m-%d")) %>%
select(-Date) %>%
mutate_all(~ ifelse(is.na(.), -1, .)) %>%
mutate(measure_date = as.Date(measure_date, format = "%Y-%m-%d"))
#SARS COUNTY CASE DATA
#sars county case
sars_casedata <- countycase_data %>%
filter(pcr_target == "sars-cov-2") %>%
select(County, measure_date, County_cases_3dayavg_r100Kutil)
#sars county case
sars_hospdata <- countycase_data %>%
filter(pcr_target == "sars-cov-2") %>%
select(County, measure_date, County_hosp_3dayavg_r100Kutil)
##RSV County Cases
rsv_casedata <- countycase_data_flursv %>%
select(County, measure_date, Percent_Diag_RSV) %>%
pivot_longer(!c(County, measure_date), names_to = "metric", values_to = "CountyCases") %>%
mutate(metric = case_when(metric == "Percent_Diag_RSV" ~ "% RSV ED Visits", TRUE ~ metric))
rsv_hosp <- countycase_data_flursv_hosp %>%
filter(pathogen == "RSV")
##Flu County Cases
flu_casedata <- countycase_data_flursv %>%
select(County, measure_date, Percent_Diag_Flu) %>%
pivot_longer(!c(County, measure_date), names_to = "metric", values_to = "CountyCases") %>%
mutate(metric = case_when(metric == "Percent_Diag_Flu" ~ "% Influenza ED Visits", TRUE ~ metric))
flu_hosp <- countycase_data_flursv_hosp %>%
filter(pathogen == "Influenza")
#grab regions from system data
region_names_sars <- System_Data %>%
select(c(utility, Region))
#import utility county reference sheet
countyperutility <- read.csv("data/WWTP_Counties_Reference.csv")
#shapes for map
wwshapes <- sf::st_read("data/shapefiles/SewershedBoundaries_Demo.shp",
stringsAsFactors = F) %>%
st_transform() %>%
st_zm() %>%
as("Spatial")
filtered_sites <- c("Utility1","Utility2","Utility3","Utility4","Utility5")
countyshapes <-
sf::st_read("data/shapefiles/Colorado_County_Boundaries.shp",
stringsAsFactors = F) %>%
st_transform() %>%
st_zm() %>%
as("Spatial")
recentData <- wwdatafull %>%
filter(!is.na(viral_conc_raw)) %>%
arrange(utility, measure_date) %>%
group_by(utility) %>%
slice_tail(n=1) %>%
ungroup()
#participation status
part_status <- IDB_masterlist %>%
filter(public_repository == "Publish") %>%
select(utility, participation_status) %>%
arrange(utility, participation_status) %>%
group_by(utility) %>%
arrange(utility) %>%
slice_head(n=1)
wwshapes@data <- wwshapes@data %>%
rename(utility = wwtp) %>%
select(utility) %>%
left_join(recentData, by = "utility") %>%
left_join(part_status, by="utility") %>%
separate(lpha1_contactname, into = c("lpha1_contactname1", "lpha1_contactname2", "lpha1_contactname3", "lpha1_contactname4", "lpha1_contactname5"), sep = ", ") %>%
separate(lpha1_contactemail, into = c("lpha1_contactemail1", "lpha1_contactemail2", "lpha1_contactemail3", "lpha1_contactemail4", "lpha1_contactemail5"), sep = ", ") %>%
mutate(lpha1_contactname1 = case_when(is.na(lpha1_contactname1) ~ "Not available", TRUE ~ lpha1_contactname1)) %>%
mutate(lpha1_contactemail1 = case_when(is.na(lpha1_contactemail1) ~ "Not available", TRUE ~ lpha1_contactemail1)) %>%
mutate(fill_color = case_when(utility %in% filtered_sites ~ "#DDCC77",
TRUE ~ "grey"),
legend_label = case_when(utility %in% filtered_sites ~ "Sentinel Sites",
TRUE ~ "Emergency Surveillance/Historic Sites"))
# view(wwshapes@data)
wwshapes <- sf::st_as_sf(wwshapes)
wwshapes <- st_transform(wwshapes, crs = 4326)
firstDate <-   wwdatafull %>%
filter(!is.na(viral_conc_raw)) %>%
group_by(utility) %>%
slice_min(order_by = measure_date, n = 1) %>%
mutate(first_date = measure_date) %>%
select(utility, first_date)
# define other global variables
utilnames <- wwdatafull %>%
group_by(utility) %>%
summarize()
System_Data_activeonly <- System_Data %>%
select(utility, population_served, county_names) %>%
left_join(IDB_masterlist, by= c("utility")) %>%
group_by(utility) %>%
slice_head(n=1) %>%
filter(Surv_System == "SSS") %>%
filter(public_repository == "Publish") %>%
filter(participation_status == "Active")
totalUtils <- System_Data_activeonly %>%
group_by(utility) %>%
summarise() %>%
nrow()
totalPop <-
round(sum(System_Data_activeonly$population_served, na.rm = TRUE)) %>%
format(
big.mark = ",",
big.interval = 3L,
digits = 1,
scientific = FALSE
)
totalCounties <-
data.frame(do.call("rbind", strsplit(
as.character(System_Data_activeonly$county_names), ",", fixed = TRUE
))) %>%
n_distinct()
totalCounties <- countyperutility %>%
filter(utility %in% System_Data_activeonly$utility) %>%
separate_rows(overlapping_counties, sep = ", ") %>%
mutate(combined_column = paste(primary_county, overlapping_counties, sep = "_")) %>%
separate_rows(combined_column, sep = "_") %>%
select(combined_column) %>%
filter(!combined_column == "") %>%
n_distinct()
bins <- c(0, 1, 2.5, 5, 7.5, 10, Inf)
pal <- colorBin("YlOrRd", domain = wwshapes$county_pos, bins = bins)
lastupdateDate <- format(file.info("data/wwdatafull.csv")$mtime, "%Y-%m-%d")
##Utilities testing new pathogens
Utilities_RSV <- IDB_masterlist %>% filter(pcr_target == "RSV_A" | pcr_target == "RSV_B" | pcr_target == "RSV A + B Combined" | pcr_target == "PanRSV") %>% select(utility) %>% distinct(utility) %>% unlist()
Utilities_Flu <- IDB_masterlist %>% filter(pcr_target == "FLUAV" | pcr_target == "FLUAB") %>% select(utility) %>% distinct(utility) %>% unlist()
}
View(plot_dat)
